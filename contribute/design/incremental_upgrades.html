<!DOCTYPE html>

<html lang="en" dir="ltr" xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Tails - Incremental upgrades</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<link rel="icon" href="../../favicon.ico" type="image/x-icon" />

<link rel="stylesheet" href="../../style.css" type="text/css" />

<link rel="stylesheet" href="../../local.css?reload-2021-06-25" type="text/css" />


<script src="../../lib/js/mirror-dispatcher.js" type="text/javascript"></script>









</head>


<body class="en">


<div class="banner" role="banner">
  <a class="tails" href="../../index.html"><span>Tails</span></a>
  <div id="search-and-donate">
    
    
    
    <div class="donate">
      <a href="https://tails.boum.org/donate/?r=topbar" class="en"><span>Donate</span></a>
      <a href="https://tails.boum.org/donate/?r=topbar" class="de"><span>Spenden</span></a>
      <a href="https://tails.boum.org/donate/?r=topbar" class="es"><span>Donar</span></a>
      <a href="https://tails.boum.org/donate/?r=topbar" class="fa"><span>اهدا کردن</span></a>
      <a href="https://tails.boum.org/donate/?r=topbar" class="fr"><span>Faire un don</span></a>
      <a href="https://tails.boum.org/donate/?r=topbar" class="it"><span>Dona</span></a>
      <a href="https://tails.boum.org/donate/?r=topbar" class="pt"><span>Faça uma doação</span></a>
      <a href="https://tails.boum.org/donate/?r=topbar" class="ru"><span>Пожертвовать</span></a>
    </div>
  </div>
</div>



<div class="topbar" role="navigation">
<ul>
  <li><a href="../../index.html">Home</a></li>
  <li><a href="../../about.en.html">How Tails works</a></li>
  <li><a href="../../install.en.html">Get Tails</a></li>
  <li><a href="../../doc.en.html">Documentation</a></li>
  <li><a href="../../support.en.html">Support</a></li>
  <li><a href="../../contribute.en.html">Contribute</a></li>
  <li><a href="../../news.en.html">News</a></li>
  <li><a href="../../jobs.html">Jobs</a></li>
</ul>


</div>



<div class="page">

<div class="pageheader">

<div class="parentlinks">
<ul id="crumbs">
<li><a href="../../index.html"><img alt="home" src="../../lib/home.png"></a></li>







<li><a href="../../contribute.en.html">contribute</a></li>





<li><a href="../design.html">design</a></li>




<li>Incremental upgrades</li>

</ul>
</div>



<div class="header">
<span class="title">
Incremental upgrades
</span>
</div>






</div>

<div id="pagebody">

<div id="content" role="main">
<div class="toc">
<ol>
	<li class="L1"><a href="#index1h1">Rationale</a>
	</li>
	<li class="L1"><a href="#index2h1">Definitions</a>
	</li>
	<li class="L1"><a href="#index3h1">Roadmap</a>
	</li>
	<li class="L1"><a href="#index4h1">Code</a>
	</li>
	<li class="L1"><a href="#index5h1">Scenarios</a>
	<ol>
		<li class="L2"><a href="#index1h2">As a Tails user</a>
		<ol>
			<li class="L3"><a href="#index1h3">When I boot Tails</a>
			</li>
		</ol>
		</li>
		<li class="L2"><a href="#index2h2">As a Tails developer</a>
		<ol>
			<li class="L3"><a href="#index2h3">When I prepare a bugfix release</a>
			</li>
			<li class="L3"><a href="#index3h3">When I prepare a major release</a>
			</li>
		</ol>
		</li>
	</ol>
	</li>
	<li class="L1"><a href="#index6h1">Implementation</a>
	<ol>
		<li class="L2"><a href="#index3h2">Upgrade paths</a>
		</li>
		<li class="L2"><a href="#index4h2">Infrastructure</a>
		<ol>
			<li class="L3"><a href="#index4h3">generate an IUK</a>
			</li>
			<li class="L3"><a href="#index5h3">Incremental Upgrade Kit</a>
			</li>
			<li class="L3"><a href="#index6h3">Mirrors infrastructure</a>
			</li>
			<li class="L3"><a href="#index7h3">Upgrade-description files</a>
			</li>
			<li class="L3"><a href="#index8h3">Initial implementation details</a>
			</li>
		</ol>
		</li>
		<li class="L2"><a href="#index5h2">Client and user interface</a>
		<ol>
			<li class="L3"><a href="#index9h3">upgrade-description downloader and verifier</a>
			</li>
			<li class="L3"><a href="#index10h3">upgrade frontend</a>
			</li>
			<li class="L3"><a href="#index11h3">target file downloader and verifier</a>
			</li>
			<li class="L3"><a href="#index12h3">install an IUK</a>
			</li>
			<li class="L3"><a href="#index13h3">full upgrade</a>
			</li>
			<li class="L3"><a href="#index14h3">signature verification</a>
			</li>
		</ol>
		</li>
	</ol>
	</li>
	<li class="L1"><a href="#index7h1">Security</a>
	<ol>
		<li class="L2"><a href="#index6h2">Upgrade-description files</a>
		</li>
		<li class="L2"><a href="#index7h2">Target files</a>
		</li>
		<li class="L2"><a href="#index8h2">Discussion</a>
		<ol>
			<li class="L3"><a href="#index15h3">Arbitrary software installation</a>
			</li>
			<li class="L3"><a href="#index16h3">Rollback attacks</a>
			</li>
			<li class="L3"><a href="#index17h3">Indefinite freeze attacks</a>
			</li>
			<li class="L3"><a href="#index18h3">Endless data attacks</a>
			</li>
			<li class="L3"><a href="#index19h3">Slow retrieval attacks</a>
			</li>
			<li class="L3"><a href="#index20h3">Extraneous dependencies attacks</a>
			</li>
			<li class="L3"><a href="#index21h3">Mix-and-match attacks</a>
			</li>
			<li class="L3"><a href="#index22h3">Wrong software installation</a>
			</li>
			<li class="L3"><a href="#index23h3">Malicious mirrors preventing upgrades</a>
			</li>
			<li class="L3"><a href="#index24h3">Vulnerability to key compromises</a>
			</li>
		</ol>
		</li>
		<li class="L2"><a href="#index9h2">Privilege separation</a>
		</li>
		<li class="L2"><a href="#index10h2">Running syslinux after applying an IUK</a>
		</li>
	</ol>
	</li>
	<li class="L1"><a href="#index8h1">Research</a>
	<ol>
		<li class="L2"><a href="#index11h2">Secure upgrade</a>
		</li>
		<li class="L2"><a href="#index12h2">Discarded options and historical information</a>
		</li>
	</ol>
	</li>
</ol>
</div>


<h1><a name="index1h1"></a>Rationale</h1>

<p>Partial upgrades should provide only what has changed between two
releases (deltas) and have a way to apply those changes to the
previous version.</p>

<p>At boot-time the security warning telling that a new Tails version is available
should provide an automated way of doing the upgrade.</p>

<h1><a name="index2h1"></a>Definitions</h1>

<ul>
<li><strong>upgrade-description file</strong>: a file that describes the upgrade from
a given version, to another, newer given version of a software
product.</li>
<li><strong>Incremental Upgrade Kit (IUK)</strong>: a file that contains everything
needed to upgrade from.</li>
<li><strong>full image</strong>: a file that is sufficient to install and run Tails
(currently, that means an ISO or USB image).</li>
<li><strong>target files</strong>: the whole set of files included by reference into
an upgrade; e.g. this may be an IUK or a full image.</li>
</ul>


<h1><a name="index3h1"></a>Roadmap</h1>

<p>See <a href="https://gitlab.tails.boum.org/tails/blueprints/-/wikis/incremental_upgrades">incremental upgrades</a>.</p>

<p><a id="code"></a></p>

<h1><a name="index4h1"></a>Code</h1>

<p>The code that implements this design lives in:</p>

<ul>
<li><a href="https://gitlab.tails.boum.org/tails/tails/-/tree/master/config/chroot_local-includes/usr/src/iuk">config/chroot local-includes/usr/src/iuk</a></li>
<li><a href="https://gitlab.tails.boum.org/tails/tails/-/blob/master/config/chroot_local-includes/usr/local/bin/tails-upgrade-frontend-wrapper">config/chroot local-includes/usr/local/bin/tails-upgrade-frontend-wrapper</a></li>
<li><a href="https://gitlab.tails.boum.org/tails/tails/-/blob/master/config/chroot_local-includes/etc/sudoers.d/zzz_upgrade">config/chroot local-includes/etc/sudoers.d/zzz upgrade</a></li>
<li><a href="https://gitlab.tails.boum.org/tails/tails/-/blob/master/config/chroot_local-includes/usr/lib/systemd/user/tails-upgrade-frontend.service">config/chroot local-includes/usr/lib/systemd/user/tails-upgrade-frontend.service</a></li>
</ul>


<h1><a name="index5h1"></a>Scenarios</h1>

<h2><a name="index1h2"></a>As a Tails user</h2>

<h3><a name="index1h3"></a>When I boot Tails</h3>

<p>The scenarios are described in Cucumber-style, using <a href="http://metacpan.org/search?q=Test%2DBDD%2DCucumber">Test-BDD-Cucumber</a>, in a [[!tais_gitweb_dir  config/chroot_local-includes/usr/src/iuk/features/frontend desc=&quot;dedicated directory&quot;]], and can be run with pherkin
(see <a href="../release_process/tails-iuk.html">tails-iuk</a> for details).</p>

<h2><a name="index2h2"></a>As a Tails developer</h2>

<h3><a name="index2h3"></a>When I prepare a bugfix release</h3>

<h4><a name="index1h4"></a>I should prepare an IUK</h4>

<p>The scenarios about this are described in Cucumber-style, using
<a href="http://metacpan.org/search?q=Test%2DBDD%2DCucumber">Test-BDD-Cucumber</a>, in [[!tais_gitweb_dir  config/chroot_local-includes/usr/src/iuk/features/create desc=&quot;dedicated directory&quot;]]. Run the <code>features/create</code> to run
them (see <a href="../release_process/tails-iuk.html">tails-iuk</a> for details).</p>

<p>Documentation on how to actually do that is on
<a href="../release_process.html#prepare-iuk">release process</a>.</p>

<h4><a name="index2h4"></a>I should test the IUK</h4>

<p>Until we have more complete <a href="https://gitlab.tails.boum.org/tails/tails/-/issues/6090">automated tests</a>,
I should manually try to install the IUK as intended on top of the old
version of Tails, and I should check that the resulting system behaves
as it should.</p>

<p>See <a href="../release_process/test.html#incremental-upgrades">test</a>.</p>

<h4><a name="index3h4"></a>I should prepare upgrade-description files</h4>

<ul>
<li>for the previous release (to announce they may upgrade using the IUK
that&#39;s being prepared)</li>
<li>for the new release (to announce no upgrade is available)</li>
</ul>


<p>See <a href="../release_process.html#prepare-upgrade-description-files">release process</a>.</p>

<h4><a name="index4h4"></a>I should publish the IUK</h4>

<p>See <a href="../release_process.html#publish-iuk">release process</a>.</p>

<h4><a name="index5h4"></a>I should publish upgrade-description files</h4>

<p>This is done at the same time as the release is announced, by simply
pushing the release Git branch live to master.</p>

<h3><a name="index3h3"></a>When I prepare a major release</h3>

<h4><a name="index6h4"></a>I should prepare an upgrade-description file</h4>

<ul>
<li>for the previous release (to announce they may upgrade using the
release that&#39;s being prepared)</li>
<li>for the new release (to announce that no upgrade is available)</li>
</ul>


<p>See <a href="../release_process.html#prepare-upgrade-description-files">release process</a>.</p>

<h4><a name="index7h4"></a>I should publish the upgrade-description file</h4>

<p>This is done at the same time as the release is announced, by simply
pushing the release Git branch live to master.</p>

<h1><a name="index6h1"></a>Implementation</h1>

<h2><a name="index3h2"></a>Upgrade paths</h2>

<p>To ease implementation, we only support upgrades from Tails versions
that have a recent enough Upgrader.</p>

<p>E.g. say one has installed Tails 0.11 a while ago, and forgets
about it. We then release Tails 0.11.1, and publish a <code>0.11_to_0.11.1</code>
IUK, advertised by the upgrade-description file for 0.11 users. We then
release Tails 0.11.2, and publish:</p>

<ul>
<li>a <code>0.11_to_0.11.2</code> IUK advertised by the upgrade-description file
for users who initially installed 0.11, regardless of whether they
already upgraded to 0.11.1 or not;</li>
<li>a <code>0.11.1_to_0.11.2</code> IUK, advertised by the upgrade-description file
for users who initially installed 0.11.1.</li>
</ul>


<h2><a name="index4h2"></a>Infrastructure</h2>

<h3><a name="index4h3"></a>generate an IUK</h3>

<p>We have a <code>tails-create-iuk</code> program that takes two Tails full images as input, and:</p>

<ul>
<li>builds the &quot;diff&quot; SquashFS</li>
<li>gets the new kernel(s), initrd(s), bootloader configuration</li>
<li>brings all this together into a single file, in the IUK format</li>
</ul>


<h3><a name="index5h3"></a>Incremental Upgrade Kit</h3>

<h4><a name="index8h4"></a>IUK format</h4>

<p>An IUK is a SquashFS archive that contains the following files:</p>

<ul>
<li><code>FORMAT</code>: contains the version of the IUK format, as
a positive integer encoded in ASCII (currently it is <em>2</em>).</li>
<li><code>control.yml</code>: YAML associative array with the following keys:

<ul>
<li><code>delete_files</code>: a list of file paths to delete from the system
partition. These paths are relative to the Tails system partition
root, and must be compatible with a FAT32 filesystem.</li>
</ul>
</li>
<li><code>overlay</code>: optional directory whose contents will be extracted onto
the system partition root, overwriting existing files: kernel(s),
initrd(s), bootloader configuration, <code>live/*.squashfs</code> (the SquashFS
&quot;diff&quot; that must be stacked on top of the SquashFS filesystem from
the initial version of Tails that was manually installed to the
device), etc. All these files target a FAT32 filesystem, so its
limitations apply (e.g. on filename, file size, permissions).</li>
</ul>


<h3><a name="index6h3"></a>Mirrors infrastructure</h3>

<p>Using something like <a href="https://wiki.mozilla.org/Software_Update:Channels">Mozilla&#39;s
channels</a>
(<em>stable</em>, <em>beta</em>, <em>nightly</em>) would e.g. allow us to push beta
upgrades earlier to a brave subset of users. Subscribing to a channel
other than <em>stable</em> is something that would be worth
<a href="../../doc/first_steps/persistence.en.html">persisting</a>. We are not likely to
implement a channels system in phase one, but the infrastructure we
set up does leave room for such future extension.</p>

<p><a id="upgrade-description-files"></a></p>

<h3><a name="index7h3"></a>Upgrade-description files</h3>

<p>We want the client to get an answer to questions such as &quot;I run
version N+2 of product P on architecture A, on a device initially
installed as version N and then upgraded to N+2, what stable release upgrade
is available?&quot;. To allow us changing the way the answer is computed in
the future, the amount of work done on the client&#39;s side should be
kept to a minimum. So, let&#39;s insert a level of indirection, and
pre-compute server-side the answer to the queries we want to support.</p>

<p>The answers are distributed on our HTTP servers in the form of a set
of upgrade-description file files.</p>

<h4><a name="index9h4"></a>upgrade-description file URL</h4>

<ul>
<li><code>https://tails.boum.org/upgrade</code></li>
<li>URL schema version (so we can change it in the future), that is currently <code>v2</code></li>
<li>product name (e.g. <em>Tails</em>, but some day we may have <em>TailsServer</em>,
<em>TailsHandheld</em> or whatever)</li>
<li>initial install version -- the version initially installed on the
device to upgrade, e.g. <em>0.11</em> or <em>0.11.1</em></li>
<li>build-target (e.g. <em>amd64</em>)</li>
<li>channel (e.g. <em>stable</em> or <em>beta</em>)</li>
<li><code>upgrade.yml</code></li>
</ul>


<p>Example: <a href="https://tails.boum.org/upgrade/v2/Tails/0.11/amd64/beta/upgrades.yml">https://tails.boum.org/upgrade/v2/Tails/0.11/amd64/beta/upgrades.yml</a></p>

<p>Such a file shall be shipped along with its OpenPGP detached signature
(<code>upgrades.yml.pgp</code>).</p>

<h4><a name="index10h4"></a>upgrade-description file format</h4>

<p>An upgrade-description file contains a YAML associative array with the
following top-level keys:</p>

<ul>
<li><code>product-name</code></li>
<li><code>initial-install-version</code></li>
<li><code>build-target</code></li>
<li><code>channel</code></li>
<li><code>upgrades</code>: a list of upgrade elements.</li>
</ul>


<p>Each upgrade element is itself an associative array describing an
upgrade to an individual product version, with the following keys:</p>

<ul>
<li><code>version</code> -- the version of this upgrade, that is the version of the
running product after the upgrade is completed and the system
restarted (e.g. <em>0.11.1</em>)</li>
<li><code>type</code> -- <em>major</em> or <em>minor</em></li>
<li><code>details-url</code> (optional) -- a URL to a web page with more
information about the specified upgrade (e.g.
<a href="https://tails.boum.org/news/version_0.11.1/">https://tails.boum.org/news/version_0.11.1/</a>)</li>
<li><code>upgrade-paths</code> -- a list of at least one and no more than two
upgrade path elements.</li>
</ul>


<p>An upgrade path element describes a set of target files that lives on
a remote server that must all be downloaded and applied to the product
to upgrade it to that version. The keys for an upgrade path element are
as follows:</p>

<ul>
<li><code>type</code> -- <em>full</em> or <em>incremental</em> (IUK are about incremental
upgrades, but let&#39;s make room to announce full images this way too
at some point)</li>
<li><code>target-files</code>: a list of target files for this upgrade path.</li>
</ul>


<p>Every target file element has the following keys:</p>

<ul>
<li><code>url</code> -- A URL to the target file.</li>
<li><code>size</code> -- The size of the upgrade, in bytes.</li>
<li><code>sha256</code> -- The SHA-256 hash of the patch file, encoded as an
hexadecimal string. If the client generated value does not match
this, the integrity check fails after download. (Other kind of
hashes may be added in a future revision of the upgrade-description
file format -- which of these multiple hashes the client must verify
will need to be specified when this happens.)</li>
</ul>


<p>Example that would be found at
<a href="https://tails.boum.org/upgrade/v2/Tails/0.11.1/amd64/stable/upgrades.yml">https://tails.boum.org/upgrade/v2/Tails/0.11.1/amd64/stable/upgrades.yml</a>:</p>

<pre><code>product-name: Tails
initial-install-version: 0.11.1
channel: stable
build-target: amd64

upgrades:
  - version: 0.11.2
    type: minor
    details-url: https://tails.boum.org/news/version_0.11.2/
    upgrade-paths:
      - type: incremental
        target-files:
          - url: http://dl.amnesia.boum.org/tails/stable/iuk/v2/Tails_amd64_0.11.1_to_0.11.2.iuk
            size: 37345648
            sha256: 5c5c47f6155e7807c971251fdad28d5f72ff78db446e43a41e4b900f29229a7d
      - type: full
        target-files:
          - url: http://dl.amnesia.boum.org/tails/stable/tails-amd64-0.11.2/Tails-amd64-0.11.2.iso
            size: 762123456
            sha256: 1015e37e14c6daaecd528b4a841ef6ac2156a5790346d0fd036f9566ce5f641b
</code></pre>

<h3><a name="index8h3"></a>Initial implementation details</h3>

<p>This section is not a specification. The URL where the IUK&#39;s are
stored, and their file name, may change. If this happens, any
upgrade-description file available on Tails HTTP mirrors, that
references an IUK whose URL changes, must be upgraded accordingly.</p>

<h4><a name="index11h4"></a>IUK file basename</h4>

<p>An IUK&#39;s file basename is not an authoritative source of information
regarding its content. However, it should be unique (among IUKs that
exist on the Tails HTTP servers at a given time).</p>

<p>An IUK&#39;s file name is built from these underscore-separated elements,
followed by the <code>.iuk</code> suffix:</p>

<ul>
<li>product name (e.g. <em>Tails</em>)</li>
<li>build-target (e.g. <em>amd64</em>)</li>
<li>initial install version -- the version initially installed on the device to
upgrade, e.g. <em>0.11</em> or <em>0.11.1</em></li>
<li><code>to</code></li>
<li>the version of this upgrade, that is the version of the running
product after the upgrade is completed and the system restarted (e.g.
<em>0.11.2</em>)</li>
</ul>


<p>Example: <code>Tails_amd64_0.11.1_to_0.11.2.iuk</code></p>

<h4><a name="index12h4"></a>IUK URL</h4>

<p>A given IUK is meant to be made available at the URL composed from:</p>

<ul>
<li><code>http://dl.amnesia.boum.org/tails/iuk/v2/</code></li>
<li>the IUK file basename</li>
</ul>


<p>Example: <a href="http://dl.amnesia.boum.org/tails/iuk/v2/Tails_amd64_0.11.1_to_0.11.2.iuk">http://dl.amnesia.boum.org/tails/iuk/v2/Tails_amd64_0.11.1_to_0.11.2.iuk</a></p>

<h2><a name="index5h2"></a>Client and user interface</h2>

<p>The program currently telling that a new Tails version is available
must be upgraded to use upgrade-description files
instead of the current Atom feed.</p>

<h3><a name="index9h3"></a>upgrade-description downloader and verifier</h3>

<p>This program has the responsibility to download and verify an
upgrade-description file.</p>

<ul>
<li>Build the URI to its upgrade-description file (might even be done at
build time and hard-coded into the image) and to its
cryptographic signature.</li>
<li>Fetch the upgrade-description file and its signature at these URIs.</li>
<li>Verify the cryptographic signature of the upgrade-description file.</li>
<li>Check that content of the upgrade-description file matches the
currently running system (in terms of product name, initial install
version, build-target and channel).</li>
<li>Once all these steps have been successfully performed, the content
of the upgrade-description file is trusted to be legit, and is
returned to the caller as such.</li>
</ul>


<p>Failure, at any of the above steps, must be reported to the caller.</p>

<h3><a name="index10h3"></a>upgrade frontend</h3>

<ul>
<li>The upgrade frontend is run (with password-less sudo) by the desktop
<code>amnesia</code> user, as the dedicated <code>tails-upgrade-frontend</code> user that
has the right to run all other incremental upgrades program as their
own dedicated user.</li>
<li>Get a verified upgrade-description file from the upgrade-description
downloader and verifier.</li>
<li>Extract information about available upgrades from the
upgrade-description file.</li>
<li>Present such information to the user, let them decide if they want
to perform the upgrade.</li>
<li>If an incremental upgrade path to the new version is available:

<ul>
<li>transform target files&#39; URL to pick one of our mirrors,
using code from <a href="https://gitlab.tails.boum.org/tails/mirror-pool-dispatcher">mirror-pool-dispatcher</a></li>
<li>securely create a tempdir in <code>tmpfs</code>, owned by
<code>tails-iuk-get-target-file:tails-iuk-get-target-file</code>,
with mode 0750</li>
<li>run the IUK downloader and verifier, asking it to drop the
verified target file into the tempdir (either the default umask
will do, or steps shall be taken to make sure the
<code>tails-install-iuk</code> user may read the resulting files)</li>
</ul>
</li>
<li>Else, point at full upgrade documentation.</li>
<li>Shutdown the network.</li>
<li>Remount the system partition read-write.</li>
<li>Perform the upgrade using the files provided by the &quot;target files
downloader and verifier&quot;.</li>
<li>Tell the user the upgrade process is finished, and they <em>MUST</em>
immediately reboot (due to system partition being left mounted
read-write, &#39;cause we cannot remount it read-only once it&#39;s been
mounted read-write).</li>
<li>The upgrade frontend checks if enough disk space is available on the
Tails system partition. The (disk space needed / target file size)
factor was defined experimentally to 3.0 (2.72 fails, 2.8 works, and
we want some safety margin in case other IUKs are not formed exactly
the same way). If too little disk space is available, the
incremental upgrade is not attempted, and the user is pointed at the
full upgrade path.</li>
<li>The upgrade frontend is run by a shell wrapper that checks if enough
free memory is available: we do not want the user to miss upgrades,
merely because the Tails Upgrader was run in low-memory conditions,
and could not do its job.</li>
</ul>


<h3><a name="index11h3"></a>target file downloader and verifier</h3>

<p>This program has the responsibility to download and verify a target
file, and make available to the caller either the verified target
file, or some error message.</p>

<ul>
<li>Takes as arguments: URI, size, hash type, hash value, destination
path where the verified target file should be left, and
possibly options.</li>
</ul>


<p>Detailed executable scenarios describe and test the behaviour of this
piece of software in Cucumber-style, using <a href="http://metacpan.org/search?q=Test%2DBDD%2DCucumber">Test-BDD-Cucumber</a>. They may be found in the
[[!tais_gitweb_dir  config/chroot_local-includes/usr/src/iuk/features/download_target_file desc=&quot;dedicated directory&quot;]], and run with pherkin
(see <a href="../release_process/tails-iuk.html">tails-iuk</a> for details).</p>

<h3><a name="index12h3"></a>install an IUK</h3>

<p>Once a user has downloaded an IUK, they must have it installed.</p>

<p>We need an installer for IUKs:</p>

<ul>
<li><strong>Input</strong>: the path to an (already verified) IUK.</li>
<li><strong>Output</strong>: success or failure (with error message when applicable).</li>
</ul>


<p>Installing an IUK should happen at the same time as normal Tails
operation, but very carefully, because we need to remount the boot
medium read-write.</p>

<ul>
<li>Verify the IUK is in a supported format.</li>
<li>Remount the boot-medium read-write.</li>
<li>Mount the IUK archive.</li>
<li>If the <code>overlay</code> directory exists in the IUK, copy its contents
onto the system partition root, overwriting existing files.</li>
<li>If a new SquashFS diff file (<code>live/*.squashfs</code>) was provided
in the <code>overlay</code> directory:

<ul>
<li>ensure <code>live/Tails.module</code> contains:

<ul>
<li>one line that says <code>filesystem.squashfs</code></li>
<li>one line that contains the filename of that new SquashFS diff</li>
</ul>
</li>
<li>remove any old SquashFS diff file that is not referenced
by <code>live/Tails.module</code> anymore.</li>
</ul>
</li>
<li>Delete files that are listed in the <code>delete_files</code> control field.</li>
<li>Upgrade syslinux with the binary found in <code>utils/linux/syslinux</code> on
the Tails system partition. Likewise, upgrade the boot device&#39;s MBR
with the one found in <code>utils/mbr/mbr.bin</code> on the Tails system
partition. This ensures that the installed version of syslinux
matches the version of the COM32 modules that were shipped by the
IUK.</li>
</ul>


<p>Detailed executable scenarios describe and test the behaviour of this
piece of software in Cucumber-style, using <a href="http://metacpan.org/search?q=Test%2DBDD%2DCucumber">Test-BDD-Cucumber</a>. They may be found in a
[[!tais_gitweb_dir  config/chroot_local-includes/usr/src/iuk/features/install desc=&quot;dedicated directory&quot;]], and run
with pherkin
(see <a href="../release_process/tails-iuk.html">tails-iuk</a> for details).</p>

<p>Resources:</p>

<ul>
<li><a href="https://wiki.mozilla.org/Software_Update:Processing_Updates">Mozilla&#39;s updates
processing</a>:
building up some mechanism (such as their pending / applying /
succeeded / failed status) to avoid retrying the same buggy upgrade
in a loop seems worth being considered.</li>
</ul>


<h3><a name="index13h3"></a>full upgrade</h3>

<p>The Tails installer is still in charge of performing full upgrades.
It deletes any <code>live/*.squashfs</code> file other than the one shipped
in the new ISO.</p>

<h3><a name="index14h3"></a>signature verification</h3>

<p>upgrade-description file polling, parsing and verification is
implemented in Perl. Signature verification is made using
<code>GnuPG::Interface</code>&#39;s <code>verify</code> method.</p>

<p>The verify method is run on a <code>GnuPG::Interface</code> object built with
<code>--homedir</code> pointed to a dedicated keyring directory, created at Tails
boot or ISO build time, that contains only the Tails signing public
OpenPGP key, which is assigned the minimum level of trust so that
GnuPG trusts the signatures made with the associated private key.</p>

<p>The <code>verify</code> method return value is <code>waitpid</code>&#39;d for, and the GnuPG
child process exit status examined (zero means verification succeeded,
non-zero means verification failure).</p>

<p><a id="security"></a></p>

<h1><a name="index7h1"></a>Security</h1>

<p>We want to use secure upgrade tools such as TUF or Thandy once they are
ready enough for production wrt. our usecases. Unfortunately, this is
not the case yet, and we haven&#39;t the resources to seriously contribute
to TUF or Thandy.</p>

<p>Therefore, given we want to have some incremental upgrade system
<em>soon</em>, the simple one we will ship in phase one will clearly be less
secure than TUF of Thandy against certain types of attacks.</p>

<p>However, we believe it is at least as secure as the way users are
currently able to manually check if a new Tails version is available,
to download and to verify it. Let&#39;s discuss this.</p>

<p>In what follows, we will call &quot;the old Tails upgrade system&quot; the way
users used to be able, as of November 2013, to manually check if
a new Tails version is available, download target files, and verify
their integrity.</p>

<h2><a name="index6h2"></a>Upgrade-description files</h2>

<p>Given:</p>

<ul>
<li>upgrade-description files are published on <a href="https://tails.boum.org/">https://tails.boum.org/</a>;
in the old Tails upgrade system, this is the canonical place where
Tails users can check for upgrades availability.</li>
<li>The upgrade-description downloader and verifier checks the SSL
certificate presented by the server is valid (in phase one, using
simple CA-based validation).</li>
</ul>


<p>Hence, the trust-path to availability and freshness of
upgrade-description files is as good as with the old Tails
upgrade system.</p>

<p>Moreover, upgrade-description files are signed by the Tails OpenPGP
signing key. Then, the trust-path to the content of upgrade-description
files is better than the old Tails upgrade system.</p>

<h2><a name="index7h2"></a>Target files</h2>

<p>Given:</p>

<ul>
<li>Communication to HTTP servers that provide target files is made over
HTTPS. However, no security is to be expected from
transport-level security here. Mirrors are not trusted anyway.</li>
<li>Availability, location, hash and size of target files are published
in upgrade-description files, towards wich some minimal trust-path
was established (see above).</li>
<li>In the old Tails upgrade system, target files are signed by the Tails
OpenPGP signing key.</li>
</ul>


<p>As a consequence, the availability, freshness and content of target
files is protected as well as it is in the old Tails upgrade system.</p>

<p><a id="security-discussion"></a></p>

<h2><a name="index8h2"></a>Discussion</h2>

<p><strong>Note</strong>: the attack definitions below come straight from the <a href="https://www.updateframework.com/wiki/Docs/Security">TUF
security
documentation</a>
(2012-05-04).</p>

<p>We believe the upgrade system described on this page is at least as
secure as the old Tails upgrade system.</p>

<h3><a name="index15h3"></a>Arbitrary software installation</h3>

<blockquote><p>An attacker installs anything they want on the client system.
That is, an attacker can provide arbitrary files in response to
download requests and the files will not be detected
as illegitimate.</p></blockquote>

<p>Both the old and new Tails upgrade systems are immune to this attack,
as long as the trust-path to the upgrade-description file is not
broken, and OpenPGP signatures on the target files are carefully
verified. We have seen above why we believe the trust-path to
upgrade-description files to be at least as secure as the old Tails
upgrade system. In the new Tails upgrade system, OpenPGP signatures are
automatically verified, which provides this kind of protection even to
users would not have checked manually in the context of the old
upgrade system.</p>

<h3><a name="index16h3"></a>Rollback attacks</h3>

<blockquote><p>An attacker presents a software upgrade system with older files than
those the client has already seen, causing the client to use files
older than those the client knows about.</p></blockquote>

<p>Given the upgrade-description downloader and verifier checks the
version of the proposed upgrades against the version of the currently
running system, the upgrade system described on this page is immune to
this attack.</p>

<h3><a name="index17h3"></a>Indefinite freeze attacks</h3>

<blockquote><p>An attacker continues to present a software upgrade system with the
same files the client has already seen. The result is that the
client does not know that new files are available.</p></blockquote>

<p>Both with the old and new Tails upgrade systems, mounting such an
attack requires either to take control of the Tails website or to
break the SSL/TLS connection between the client and the server.</p>

<p>This attack is slightly mitigated by the fact that we are announcing
new releases in other ways:</p>

<ul>
<li>one that does not rely on our website at all (Twitter);</li>
<li>one that does not rely on our website to be safe at the time Tails
Upgrader checks for available upgrades, as long as it was safe at
the time the new release was published (<a href="../../about/contact.en.html#amnesia-news">amnesia-news@boum.org</a>
announce mailing list).</li>
</ul>


<p>The move to a secure upgrade system, such as TUF, would make this
stronger, thanks to short-lived signatures on meta-data.</p>

<h3><a name="index18h3"></a>Endless data attacks</h3>

<blockquote><p>An attacker responds to a file download request with an endless
stream of data, causing harm to clients (e.g. a disk partition
filling up or memory exhaustion).</p></blockquote>

<p>The old Tails upgrade system offers no protection at all against
performing this class of attacks, so the new one cannot do worse.</p>

<p>However, the new Tails upgrade system, by including the expected size
of the target files in the set of meta-data verified before
downloading them, allows the target files downloader and verifier to
avoid downloading more data than expected (thanks to <a href="http://metacpan.org/search?q=LWP%3A%3AUserAgent">LWP::UserAgent</a>&#39;s <code>max_size</code> method).</p>

<p>The upgrade-description files downloader and verifier could refuse to
download upgrade-description files bigger than some reasonable
constant, but this is not implemented yet.</p>

<p>This attack, when performed against the upgrade-description files
downloader and verifier is slightly mitigated in the same way as
&quot;Indefinite freeze attacks&quot; are.</p>

<h3><a name="index19h3"></a>Slow retrieval attacks</h3>

<blockquote><p>An attacker responds to clients with a very slow stream of data that
essentially results in the client never continuing the
upgrade process.</p></blockquote>

<p>The old Tails upgrade system offers no protection at all against this
class of attacks, so the new one cannot do worse. However, one change
brought by the new Tails upgrade system is that we control the
programs used to download upgrade-description files and target files;
hence, we could set timeouts on download operations so that, at least,
the user can be made aware of what is happening. Currently, the
default timeout settings (if any) of these programs, libraries, and
underlying kernel networking code are used.</p>

<h3><a name="index20h3"></a>Extraneous dependencies attacks</h3>

<blockquote><p>An attacker indicates to clients that in order to install the
software they wanted, they also need to install unrelated software.
This unrelated software can be from a trusted source but may have
known vulnerabilities that are exploitable by the attacker.</p></blockquote>

<p>In the old Tails upgrade system, changing the list of needed files
could be done by taking control of the Tails website or breaking the
client/server SSL/TLS connection; in the new Tails upgrade system,
mounting this attack requires being able to sign a modified
upgrade-description file with the Tails OpenPGP signing key instead,
which is most probably harder.</p>

<h3><a name="index21h3"></a>Mix-and-match attacks</h3>

<blockquote><p>An attacker presents clients with a view of a repository that
includes files that never existed together on the repository at the
same time. This can result in, for example, outdated versions of
dependencies being installed.</p></blockquote>

<p>The list of needed target files to perform an upgrade, along with their
hashes, is available in a single location, that is in an
upgrade-description file; therefore, we believe the upgrade system
described on this page to be immune to mix-and-match attacks.</p>

<h3><a name="index22h3"></a>Wrong software installation</h3>

<blockquote><p>An attacker provides a client with a trusted file that is not the
one the client wanted.</p></blockquote>

<p>The old Tails upgrade system does not protect against this attack:
a mirror can replace an ISO file and its detached OpenPGP signature
with an obsolete pair of files, renamed to match the expected file
names of the new release. Given some released versions of Tails
shipped with a dysfunctional &quot;security warning if upgrade is
available&quot; system, many users would probably not notice.</p>

<p>The new Tails upgrade system is as secure, wrt. wrong software
installation attacks, as the trust-path to upgrade-description files
are. Breaking this is clearly harder than renaming a pair of files on
a mirror controlled by an attacker, so the new Tails upgrade system is
more secure than the old one against wrong software installation.</p>

<h3><a name="index23h3"></a>Malicious mirrors preventing upgrades</h3>

<blockquote><p>An attacker in control of one repository mirror is able to prevent
users from obtaining upgrades from other, good mirrors.</p></blockquote>

<p>In both the old and new Tails upgrade systems, mirrors are used for
target files only, as part of a DNS round-robin pool that contains
more than 6 members, so when retrying a failed download at a later
time, one is likely to land onto another mirror. We then believe both
the old and new Tails upgrade system to be relatively safe from this
class of attacks, as long as failed downloads are tried again later.</p>

<h3><a name="index24h3"></a>Vulnerability to key compromises</h3>

<blockquote><p>An attacker who is able to compromise a single key or less than
a given threshold of keys can compromise clients. This includes
relying on a single online key (such as only being protected by SSL)
or a single offline key (such as most software upgrade systems use to
sign files).</p></blockquote>

<p>Both the old and new Tails upgrade systems are vulnerable to this class
of attacks, due to the reliance on the Tails OpenPGP signing key.
The future move to a secure upgrade system such as TUF or Thandy will
fix this.</p>

<h2><a name="index9h2"></a>Privilege separation</h2>

<p>The default Live user (<code>amnesia</code>) is allowed to run the upgrade
frontend, without arguments, as the dedicated <code>tails-upgrade-frontend</code>
user, who itself:</p>

<ul>
<li>is allowed to run the <code>tails-shutdown-network</code> and <code>/sbin/reboot</code>
programs, using passwordless sudo, as any user;</li>
<li>is allowed to run the <code>tails-install-iuk</code> program, with any
arguments, using passwordless sudo, as the <code>tails-install-iuk</code> user;</li>
<li>is allowed to run the <code>tails-iuk-get-target-file</code> program, with any
argument, using passwordless sudo, as the
<code>tails-iuk-get-target-file</code> user;</li>
<li>is allowed to run <code>tails-iuk-mktemp-get-target-file</code>, using
passwordless sudo, as the <code>tails-iuk-get-target-file</code> user;</li>
<li>is allowed to run <code>tails-iuk-cancel-download</code>, using passwordless sudo,
as any user.</li>
</ul>


<p>The <code>tails-install-iuk</code> user is allowed to run, using passwordless
sudo, every command required by its task with any arguments.
This includes e.g. <code>cp</code> so for all practical security purposes,
it can effectively escalate to arbitrary code execution as root.
It is a member of the <code>tails-iuk-get-target-file</code> group, which allows it to
read the files downloaded by the <code>tails-iuk-get-target-file</code> program.</p>

<h2><a name="index10h2"></a>Running syslinux after applying an IUK</h2>

<p>Anyone who can feed <code>tails-install-iuk</code> with an arbitrary IUK can run
arbitrary code as root, by storing the attack code in one of the
tarballs contained in the IUK, as <code>utils/linux/syslinux</code>. This does
not introduce new security risks: the very same adversary could plant
a persistent rootkit anyway. Our protection against this instead
relies in the privilege separation described above: all that the
<code>amnesia</code> user can do is run the frontend with no arguments.</p>

<h1><a name="index8h1"></a>Research</h1>

<h2><a name="index11h2"></a>Secure upgrade</h2>

<ul>
<li><a href="https://www.updateframework.com/">TUF: The Update Framework</a></li>
<li><a href="https://gitweb.torproject.org/thandy.git/blob_plain/HEAD:/specs/thandy-spec.txt">Thandy specification</a></li>
</ul>


<h2><a name="index12h2"></a>Discarded options and historical information</h2>

<p>See the <a href="./incremental_upgrades/archive.html">page about discarded options and historical
information</a>.</p>



</div>







</div>

<div id="footer" class="pagefooter" role="contentinfo">

<div id="pageinfo">







<div id="backlinks">
Pages linking to this one:

<a href="../design.html">design</a>

<a href="../glossary.html">glossary</a>

<a href="./installation.html">installation</a>

<a href="../../news/test_incremental_upgrades.html">news/test incremental upgrades</a>

<a href="../release_process.html">release process</a>


</div>






</div>
<div id="mirrorlist">Mirror: <a href="https://tails.boum.org/ikiwiki.cgi?do=goto&page=contribute/design/incremental_upgrades">tails.boum.org</a></div>

<!-- from The Amnesic Incognito Live System -->
</div>

</div>

<script type="text/javascript">
  var linkelements = document.querySelectorAll('.use-mirror-pool');
  // Avoid a traceback if mirror-dispatcher.js is not available.
  if (typeof replaceUrlPrefixWithRandomMirror !== "undefined" && linkelements.length > 0) {
    replaceUrlPrefixWithRandomMirror(linkelements);
  }
</script>

</body>
</html>
