<!DOCTYPE html>

<html lang="en" dir="ltr" xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Tails - Tagged snapshots of upstream APT repositories</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<link rel="icon" href="../../favicon.ico" type="image/x-icon" />

<link rel="stylesheet" href="../../style.css" type="text/css" />

<link rel="stylesheet" href="../../local.css?reload-2021-06-25" type="text/css" />


<script src="../../lib/js/mirror-dispatcher.js" type="text/javascript"></script>









</head>


<body class="en">


<div class="banner" role="banner">
  <a class="tails" href="../../index.html"><span>Tails</span></a>
  <div id="search-and-donate">
    
    
    
    <div class="donate">
      <a href="https://tails.boum.org/donate/?r=topbar" class="en"><span>Donate</span></a>
      <a href="https://tails.boum.org/donate/?r=topbar" class="de"><span>Spenden</span></a>
      <a href="https://tails.boum.org/donate/?r=topbar" class="es"><span>Donar</span></a>
      <a href="https://tails.boum.org/donate/?r=topbar" class="fa"><span>اهدا کردن</span></a>
      <a href="https://tails.boum.org/donate/?r=topbar" class="fr"><span>Faire un don</span></a>
      <a href="https://tails.boum.org/donate/?r=topbar" class="it"><span>Dona</span></a>
      <a href="https://tails.boum.org/donate/?r=topbar" class="pt"><span>Faça uma doação</span></a>
      <a href="https://tails.boum.org/donate/?r=topbar" class="ru"><span>Пожертвовать</span></a>
    </div>
  </div>
</div>



<div class="topbar" role="navigation">
<ul>
  <li><a href="../../index.html">Home</a></li>
  <li><a href="../../about.en.html">How Tails works</a></li>
  <li><a href="../../install.en.html">Get Tails</a></li>
  <li><a href="../../doc.en.html">Documentation</a></li>
  <li><a href="../../support.en.html">Support</a></li>
  <li><a href="../../contribute.en.html">Contribute</a></li>
  <li><a href="../../news.en.html">News</a></li>
  <li><a href="../../jobs.html">Jobs</a></li>
</ul>


</div>



<div class="page">

<div class="pageheader">

<div class="parentlinks">
<ul id="crumbs">
<li><a href="../../index.html"><img alt="home" src="../../lib/home.png"></a></li>







<li><a href="../../contribute.en.html">contribute</a></li>





<li><a href="../APT_repository.html">APT repository</a></li>




<li>Tagged snapshots of upstream APT repositories</li>

</ul>
</div>



<div class="header">
<span class="title">
Tagged snapshots of upstream APT repositories
</span>
</div>






</div>

<div id="pagebody">

<div id="content" role="main">
<div class="toc">
<ol>
	<li class="L1"><a href="#index1h1">Overview</a>
	</li>
	<li class="L1"><a href="#index2h1">Source code</a>
	</li>
	<li class="L1"><a href="#index3h1">Design notes</a>
	<ol>
		<li class="L2"><a href="#index1h2">Listing needed packages</a>
		</li>
		<li class="L2"><a href="#index2h2">Importing packages into partial snapshots</a>
		</li>
		<li class="L2"><a href="#index3h2">Valid-Until</a>
		</li>
		<li class="L2"><a href="#index4h2">Garbage collection</a>
		</li>
	</ol>
	</li>
	<li class="L1"><a href="#index4h1">Known issues</a>
	<ol>
		<li class="L2"><a href="#index5h2">Unusable tagged APT snapshots generated for unused APT sources</a>
		</li>
	</ol>
	</li>
</ol>
</div>


<h1><a name="index1h1"></a>Overview</h1>

<p>Our tagged snapshots of upstream APT repositories are published on
<a href="http://tagged.snapshots.deb.tails.boum.org/">http://tagged.snapshots.deb.tails.boum.org/</a>.</p>

<p>These are <em>partial</em>, tagged snapshots of upstream APT repositories we
need, so that one can rebuild a released ISO in the future, and we
keep the corresponding source code around.</p>

<p>The main goal here is having reproducible builds some day, and to
comply with various licenses such as the GPL.</p>

<p>These snapshots are partial: in a given snapshot, we import only the
packages needed by a given build of Tails.</p>

<p>The corresponding data shall be backup&#39;ed, and expired very
cautiously, if ever.</p>

<h1><a name="index2h1"></a>Source code</h1>

<ul>
<li><code>tails::reprepro::snapshots::tagged</code> class in
<a href="https://gitlab.tails.boum.org/tails/puppet-tails/-/blob/master/"></a></li>
<li>bits scattered in the main Tails Git repository (details below)</li>
</ul>


<h1><a name="index3h1"></a>Design notes</h1>

<h2><a name="index1h2"></a>Listing needed packages</h2>

<p>To generate partial APT repositories, we need to know what to include
in them. Therefore, we create a <em>build manifest</em> at the end of an ISO
build. It is generated by
<a href="https://gitlab.tails.boum.org/tails/tails/-/blob/master/auto/scripts/generate-build-manifest">auto/scripts/generate-build-manifest</a>, thanks to
<a href="https://gitlab.tails.boum.org/tails/tails/-/blob/master/data/wrappers/apt-get">data/wrappers/apt-get</a> and
<a href="https://gitlab.tails.boum.org/tails/tails/-/blob/master/data/debootstrap/scripts/debian-common.patch">data/debootstrap/scripts/debian-common.patch</a>.</p>

<p>Output:</p>

<ul>
<li>for each APT repository we use time-based snapshots for: name, serial</li>
<li>for each binary package: name, version, architecture</li>
<li>for each source package: name, version</li>
</ul>


<p>In passing, here are some nice side-effects of having this build
manifest:</p>

<ul>
<li>It allows to inspect the diff between the subset of two different
snapshots that was used at build time; the benefit is quite small as
long as we&#39;re based on Debian stable (we also fetch packages from
testing, sid, backports, etc. though), but if/when we switch to
being based on Debian testing, then we will definitely want that.</li>
<li>Say a branch (topic one, or devel, etc.) introduces a regression,
and has changes in the set of packages used at build time, we may
want to check how exactly that set was changed. Think &quot;check the
diff between <code>.packages</code>&quot; as we do at release time, but done in
a more correct way.</li>
</ul>


<h2><a name="index2h2"></a>Importing packages into partial snapshots</h2>

<h3><a name="index1h3"></a>How it&#39;s done in practice</h3>

<ul>
<li><a href="https://gitlab.tails.boum.org/tails/tails/-/blob/master/auto/scripts/tag-apt-snapshots">auto/scripts/tag-apt-snapshots</a></li>
<li><a href="https://gitlab.tails.boum.org/tails/puppet-tails/-/blob/master/files/reprepro/snapshots/tagged/tails-prepare-tagged-apt-snapshot-import">tails-prepare-tagged-apt-snapshot-import</a></li>
<li><a href="https://gitlab.tails.boum.org/tails/puppet-tails/-/blob/master/files/reprepro/snapshots/time_based/tails-publish-tagged-apt-snapshot">tails-publish-tagged-apt-snapshot</a></li>
</ul>


<h3><a name="index2h3"></a>A corner case: APT pinning magics</h3>

<p>If a (package, version) is seen at build time in 2 or more APT
sources, <code>tails-prepare-tagged-apt-snapshot-import</code> injects it
into each of the tagged snapshots corresponding to these sources.</p>

<p>The goal is to avoid this scenario, that could happen if we injected
each package <em>only</em> into the distribution it was downloaded from:</p>

<ul>
<li>version X of package P is available both in suite S1 on origin O1,
and in suite S2 on origin O2</li>
<li>version Y of package P is available in suite S3 of origin O3</li>
<li>our pinning makes us prefer version X of package P <em>because it&#39;s
available in O1/S1</em>; otherwise, if it wasn&#39;t in there, then our
pinning would make APT prefer version Y to version X</li>
<li>at ISO build time, APT fetches package P version X from O2/S2</li>
<li>given this build manifest, we import package P version X into our
tagged snapshot of O2/S2, but not into our tagged snapshot of O1/S1</li>
<li>if we rebuild from the same source tree using that set of tagged
snapshots, then version Y of package P will be installed</li>
</ul>


<p>This scenario can happen in practice:</p>

<pre><code># cat /etc/apt/sources.list
deb http://security.debian.org wheezy/updates main
deb http://ftp.us.debian.org/debian/ wheezy main
deb http://ftp.us.debian.org/debian/ jessie main

# cat /etc/apt/preferences
Package: *
Pin: origin security.debian.org
Pin-Priority: -10

Package: *
Pin: release o=Debian,n=wheezy
Pin-Priority: 990

Package: *
Pin: release o=Debian,n=jessie
Pin-Priority: 700

# apt-cache madison a2ps
a2ps | 1:4.14-1.3 | http://ftp.us.debian.org/debian/ jessie/main amd64 Packages
a2ps | 1:4.14-1.1+deb7u1 | http://security.debian.org/ wheezy/updates/main amd64 Packages
a2ps | 1:4.14-1.1+deb7u1 | http://ftp.us.debian.org/debian/ wheezy/main amd64 Packages

# apt-cache policy a2ps
a2ps:
  Installed: (none)
  Candidate: 1:4.14-1.1+deb7u1
  Version table:
     1:4.14-1.3 0
        700 http://ftp.us.debian.org/debian/ jessie/main amd64 Packages
     1:4.14-1.1+deb7u1 0
        -10 http://security.debian.org/ wheezy/updates/main amd64 Packages
        990 http://ftp.us.debian.org/debian/ wheezy/main amd64 Packages
</code></pre>

<p>And then, APT will download <code>a2ps</code> from security.d.o:</p>

<pre><code># apt-get download a2ps --print-uris
&#39;http://security.debian.org/pool/updates/main/a/a2ps/a2ps_4.14-1.1+deb7u1_amd64.deb&#39; a2ps_4.14-1.1+deb7u1_amd64.deb 956298 sha256:e47d7fe9adb7aa62421108debf425830f4e2385e98151c5cb359d3eb8688eea8
</code></pre>

<p>... but if <code>a2ps</code> was not available in the regular Wheezy archive,
e.g. because we were using a tagged snapshot that imported <code>a2ps</code> into
the security archive, then APT would prefer <code>a2ps</code> from Jessie, which
demonstrates the problem.</p>

<h2><a name="index3h2"></a>Valid-Until</h2>

<p>A tagged APT repository snapshot that was used to build a given Tails
release is immutable by design, so it does not need the protections
provided by <code>Valid-Until</code>. Besides, not using <code>Valid-Until</code> for those
makes it much easier to reproduce a given ISO build in the future.</p>

<p>So, the <code>Release</code> files for tagged snapshots have no
<code>Valid-Until</code> field.</p>

<h2><a name="index4h2"></a>Garbage collection</h2>

<p>We want to keep &quot;forever&quot; the tagged snapshots used by Tails releases.</p>

<p>In practice, &quot;forever&quot; == min(3 years for GPL, how long we want to be
able to reproduce the build of a released ISO) = 3 years.</p>

<p>Depending on the growth rate of our tagged snapshots in practice, we
may or may not need to implement expiration of these snapshots any
time soon. Time will tell.</p>

<h1><a name="index4h1"></a>Known issues</h1>

<h2><a name="index5h2"></a>Unusable tagged APT snapshots generated for unused APT sources</h2>

<p>When an APT source from which we pull no package at ISO build time is
configured in the Tails Git repository, the tagged APT snapshot
generated for that APT source will be unusable, which breaks the
ISO build.</p>

<p>To avoid this problem, ensure we do not enable any useless APT source
at ISO build time.</p>



</div>







</div>

<div id="footer" class="pagefooter" role="contentinfo">

<div id="pageinfo">







<div id="backlinks">
Pages linking to this one:

<a href="../APT_repository.html">APT repository</a>

<a href="../working_together/roles/sysadmins.html">working together/roles/sysadmins</a>


</div>






</div>
<div id="mirrorlist">Mirror: <a href="https://tails.boum.org/ikiwiki.cgi?do=goto&page=contribute/APT_repository/tagged_snapshots">tails.boum.org</a></div>

<!-- from The Amnesic Incognito Live System -->
</div>

</div>

<script type="text/javascript">
  var linkelements = document.querySelectorAll('.use-mirror-pool');
  // Avoid a traceback if mirror-dispatcher.js is not available.
  if (typeof replaceUrlPrefixWithRandomMirror !== "undefined" && linkelements.length > 0) {
    replaceUrlPrefixWithRandomMirror(linkelements);
  }
</script>

</body>
</html>
